# RadioCalico Development Docker Compose Configuration
# Run with: docker-compose -f docker-compose.dev.yml up

version: '3.8'

services:
  # Express Frontend Server
  express:
    build:
      context: .
      dockerfile: Dockerfile.express
    container_name: radiocalico-express-dev
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - FLASK_HOST=flask
      - FLASK_PORT=5000
      - DATABASE_PATH=/app/data/database.sqlite
    volumes:
      # Mount source code for hot reload
      - ./server.js:/app/server.js
      - ./database.js:/app/database.js
      - ./public:/app/public
      - ./stream_URL.txt:/app/stream_URL.txt
      # Persist database
      - express_db:/app/data
    networks:
      - radiocalico-net
    depends_on:
      - flask
    restart: unless-stopped

  # Flask Backend API
  flask:
    build:
      context: .
      dockerfile: Dockerfile.flask
    container_name: radiocalico-flask-dev
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=development
      - FLASK_PORT=5000
      - FLASK_DATABASE_PATH=/app/data/flask_database.sqlite
    volumes:
      # Mount source code for hot reload
      - ./flask_app.py:/app/flask_app.py
      - ./metadata_poller.py:/app/metadata_poller.py
      - ./stream_URL.txt:/app/stream_URL.txt
      # Persist database (shared with metadata-poller)
      - flask_db:/app/data
    networks:
      - radiocalico-net
    restart: unless-stopped

  # Metadata Poller (Background Service)
  metadata-poller:
    build:
      context: .
      dockerfile: Dockerfile.flask
    container_name: radiocalico-poller-dev
    environment:
      - FLASK_DATABASE_PATH=/app/data/flask_database.sqlite
    volumes:
      - ./metadata_poller.py:/app/metadata_poller.py
      # Share database volume with Flask
      - flask_db:/app/data
    command: ["python", "metadata_poller.py"]
    networks:
      - radiocalico-net
    depends_on:
      - flask
    restart: unless-stopped

networks:
  radiocalico-net:
    name: radiocalico-dev-net
    driver: bridge

volumes:
  express_db:
    name: radiocalico_express_db_dev
  flask_db:
    name: radiocalico_flask_db_dev
